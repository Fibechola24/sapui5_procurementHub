<mvc:View
    xmlns="sap.m"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns:layout="sap.ui.layout"
    xmlns:viz="sap.viz.ui5.controls"
    xmlns:viz.feeds="sap.viz.ui5.controls.common.feeds"
    xmlns:viz.data="sap.viz.ui5.data"
    xmlns:f="sap.f"
    xmlns:card="sap.f.cards"
    xmlns:core="sap.ui.core"
    controllerName="ui5.procurementhub.controller.Analytics"
    displayBlock="true">
    
    <Page 
        id="analyticsPage"
        title="Procurement Analytics"
        showNavButton="true"
        navButtonPress=".onNavBack"
        class="sapUiResponsiveContentPadding">
        
        <headerContent>
            <Button 
                icon="sap-icon://refresh"
                tooltip="Refresh Data"
                press=".onRefresh"/>
            <Button 
                icon="sap-icon://download"
                tooltip="Export Report"
                press=".onExport"/>
            <Button 
                icon="sap-icon://filter"
                tooltip="Filter"
                press=".onOpenFilter"/>
        </headerContent>
        
        <content>
            <ScrollContainer 
                height="100%" 
                width="100%" 
                vertical="true" 
                horizontal="false">
                
                <!-- Time Period Selector -->
                <Panel headerText="Analytics Period" class="sapUiNoContentPadding sapUiMediumMarginBottom">
                    <content>
                        <HBox class="sapUiSmallMargin" alignItems="Center" wrap="Wrap">
                            <Label text="Time Period:" class="sapUiTinyMarginEnd"/>
                            <Select 
                                selectedKey="{analytics>/timePeriod}"
                                width="200px"
                                change=".onTimePeriodChange">
                                <core:Item key="LAST_7_DAYS" text="Last 7 Days"/>
                                <core:Item key="LAST_30_DAYS" text="Last 30 Days"/>
                                <core:Item key="THIS_MONTH" text="This Month"/>
                                <core:Item key="LAST_MONTH" text="Last Month"/>
                                <core:Item key="THIS_QUARTER" text="This Quarter"/>
                                <core:Item key="LAST_QUARTER" text="Last Quarter"/>
                                <core:Item key="THIS_YEAR" text="This Year"/>
                                <core:Item key="CUSTOM" text="Custom Range"/>
                            </Select>
                            
                            <HBox class="sapUiSmallMarginBegin" visible="{= ${analytics>/timePeriod} === 'CUSTOM' }">
                                <DatePicker 
                                    placeholder="From Date"
                                    value="{analytics>/dateFrom}"
                                    class="sapUiTinyMarginEnd"/>
                                <DatePicker 
                                    placeholder="To Date"
                                    value="{analytics>/dateTo}"/>
                            </HBox>
                            
                            <ToolbarSpacer/>
                            <Button 
                                text="Apply"
                                type="Emphasized"
                                press=".onApplyFilter"/>
                        </HBox>
                    </content>
                </Panel>
                
                <!-- KPI Overview Cards - FIXED: Using sap.f.Card instead of HeaderContainer -->
                <Panel headerText="Key Metrics" class="sapUiNoContentPadding sapUiMediumMarginBottom">
                    <content>
                        <HBox class="sapUiSmallMargin" wrap="Wrap" justifyContent="SpaceBetween">
                            <!-- Total Spend Card -->
                            <f:Card width="300px" class="sapUiSmallMargin">
                                <f:header>
                                    <card:Header 
                                        title="Total Spend"
                                        subtitle="Current Period"/>
                                </f:header>
                                <f:content>
                                    <layout:VerticalLayout class="sapUiContentPadding">
                                        <HBox alignItems="End" justifyContent="SpaceBetween">
                                            <Title text="{analytics>/kpis/totalSpend/value}" level="H1" class="sapUiTinyMarginBottom"/>
                                            <core:Icon 
                                                src="sap-icon://money-bills"
                                                size="2rem"
                                                color="#0070F2"/>
                                        </HBox>
                                        <Text text="{analytics>/kpis/totalSpend/unit}" class="sapUiTinyMarginTop"/>
                                        <ObjectStatus 
                                            text="{analytics>/kpis/totalSpend/trend}"
                                            state="{analytics>/kpis/totalSpend/trendState}"
                                            class="sapUiTinyMarginTop"/>
                                    </layout:VerticalLayout>
                                </f:content>
                            </f:Card>
                            
                            <!-- Average Processing Time -->
                            <f:Card width="300px" class="sapUiSmallMargin">
                                <f:header>
                                    <card:Header 
                                        title="Avg. Processing Time"
                                        subtitle="Days to Approval"/>
                                </f:header>
                                <f:content>
                                    <layout:VerticalLayout class="sapUiContentPadding">
                                        <HBox alignItems="End" justifyContent="SpaceBetween">
                                            <Title text="{analytics>/kpis/avgProcessingTime/value}" level="H1" class="sapUiTinyMarginBottom"/>
                                            <core:Icon 
                                                src="sap-icon://time-entry-request"
                                                size="2rem"
                                                color="#19A979"/>
                                        </HBox>
                                        <Text text="{analytics>/kpis/avgProcessingTime/unit}" class="sapUiTinyMarginTop"/>
                                        <ObjectStatus 
                                            text="{analytics>/kpis/avgProcessingTime/trend}"
                                            state="{analytics>/kpis/avgProcessingTime/trendState}"
                                            class="sapUiTinyMarginTop"/>
                                    </layout:VerticalLayout>
                                </f:content>
                            </f:Card>
                            
                            <!-- Approval Rate -->
                            <f:Card width="300px" class="sapUiSmallMargin">
                                <f:header>
                                    <card:Header 
                                        title="Approval Rate"
                                        subtitle="Successful Approvals"/>
                                </f:header>
                                <f:content>
                                    <layout:VerticalLayout class="sapUiContentPadding">
                                        <HBox alignItems="End" justifyContent="SpaceBetween">
                                            <Title text="{analytics>/kpis/approvalRate/value}" level="H1" class="sapUiTinyMarginBottom"/>
                                            <core:Icon 
                                                src="sap-icon://approvals"
                                                size="2rem"
                                                color="#E39B1A"/>
                                        </HBox>
                                        <Text text="{analytics>/kpis/approvalRate/unit}" class="sapUiTinyMarginTop"/>
                                        <ObjectStatus 
                                            text="{analytics>/kpis/approvalRate/trend}"
                                            state="{analytics>/kpis/approvalRate/trendState}"
                                            class="sapUiTinyMarginTop"/>
                                    </layout:VerticalLayout>
                                </f:content>
                            </f:Card>
                            
                            <!-- Cost Savings -->
                            <f:Card width="300px" class="sapUiSmallMargin">
                                <f:header>
                                    <card:Header 
                                        title="Cost Savings"
                                        subtitle="This Period"/>
                                </f:header>
                                <f:content>
                                    <layout:VerticalLayout class="sapUiContentPadding">
                                        <HBox alignItems="End" justifyContent="SpaceBetween">
                                            <Title text="{analytics>/kpis/costSavings/value}" level="H1" class="sapUiTinyMarginBottom"/>
                                            <core:Icon 
                                                src="sap-icon://savings"
                                                size="2rem"
                                                color="#36CE6C"/>
                                        </HBox>
                                        <Text text="{analytics>/kpis/costSavings/unit}" class="sapUiTinyMarginTop"/>
                                        <ObjectStatus 
                                            text="{analytics>/kpis/costSavings/trend}"
                                            state="{analytics>/kpis/costSavings/trendState}"
                                            class="sapUiTinyMarginTop"/>
                                    </layout:VerticalLayout>
                                </f:content>
                            </f:Card>
                        </HBox>
                    </content>
                </Panel>
                
                <!-- Charts Row 1 -->
                <HBox class="sapUiSmallMarginBottom" wrap="Wrap">
                    <!-- Monthly Spend Trend -->
                    <Panel headerText="Monthly Spend Trend" width="600px" height="400px" class="sapUiTinyMargin">
                        <content>
                            <!-- Using simple visualization or alternative to viz charts -->
                            <VBox height="100%" width="100%" alignItems="Center" justifyContent="Center">
                                <Image src="sap-icon://chart-axis" decorative="true" width="60px" height="60px" 
                                       class="sapUiMediumMargin"/>
                                <Text text="Monthly Spend Chart" class="sapUiSmallMargin"/>
                                <Text text="(Chart visualization would appear here)" class="sapUiTinyMargin sapUiSmallText"/>
                                <Button text="Show Chart Data" press=".onShowMonthlySpend" class="sapUiTinyMarginTop"/>
                            </VBox>
                        </content>
                    </Panel>
                    
                    <!-- Spend by Department -->
                    <Panel headerText="Spend by Department" width="600px" height="400px" class="sapUiTinyMargin">
                        <content>
                            <!-- Using List instead of Pie Chart for compatibility -->
                            <List 
                                items="{analytics>/departmentSpend}"
                                class="sapUiNoContentPadding">
                                <StandardListItem
                                    title="{analytics>department}"
                                    description="Spend: ${analytics>amount}"
                                    info="{analytics>percentage}"
                                    infoState="Success"
                                    type="Active"/>
                            </List>
                        </content>
                    </Panel>
                </HBox>
                
                <!-- Charts Row 2 -->
                <HBox class="sapUiSmallMarginBottom" wrap="Wrap">
                    <!-- PR Status Distribution -->
                    <Panel headerText="PR Status Distribution" width="600px" height="400px" class="sapUiTinyMargin">
                        <content>
                            <VBox height="100%" width="100%" class="sapUiSmallPadding">
                                <HBox justifyContent="SpaceBetween" class="sapUiSmallMarginBottom">
                                    <ObjectStatus 
                                        text="Approved"
                                        state="Success"
                                        icon="sap-icon://accept"/>
                                    <Text text="{analytics>/prStatus/0/count} PRs"/>
                                </HBox>
                                <HBox justifyContent="SpaceBetween" class="sapUiSmallMarginBottom">
                                    <ObjectStatus 
                                        text="Pending"
                                        state="Warning"
                                        icon="sap-icon://pending"/>
                                    <Text text="{analytics>/prStatus/1/count} PRs"/>
                                </HBox>
                                <HBox justifyContent="SpaceBetween" class="sapUiSmallMarginBottom">
                                    <ObjectStatus 
                                        text="Rejected"
                                        state="Error"
                                        icon="sap-icon://decline"/>
                                    <Text text="{analytics>/prStatus/2/count} PRs"/>
                                </HBox>
                                <HBox justifyContent="SpaceBetween" class="sapUiSmallMarginBottom">
                                    <ObjectStatus 
                                        text="Draft"
                                        state="None"
                                        icon="sap-icon://create"/>
                                    <Text text="{analytics>/prStatus/3/count} PRs"/>
                                </HBox>
                            </VBox>
                        </content>
                    </Panel>
                    
                    <!-- Top Suppliers -->
                    <Panel headerText="Top Suppliers by Spend" width="600px" height="400px" class="sapUiTinyMargin">
                        <content>
                            <Table 
                                items="{analytics>/topSuppliers}"
                                class="sapUiNoContentPadding">
                                <columns>
                                    <Column>
                                        <Text text="Supplier"/>
                                    </Column>
                                    <Column width="120px">
                                        <Text text="Spend"/>
                                    </Column>
                                    <Column width="80px">
                                        <Text text="%"/>
                                    </Column>
                                </columns>
                                <items>
                                    <ColumnListItem>
                                        <cells>
                                            <Text text="{analytics>supplier}"/>
                                            <ObjectNumber 
                                                number="{analytics>amount}"
                                                unit="USD"
                                                state="Success"/>
                                            <ProgressIndicator 
                                                percentValue="{analytics>percentage}"
                                                displayValue="{analytics>percentage}%"
                                                showValue="true"
                                                state="Success"/>
                                        </cells>
                                    </ColumnListItem>
                                </items>
                            </Table>
                        </content>
                    </Panel>
                </HBox>
                
                <!-- Process Timeline - Simplified -->
                <Panel headerText="Procurement Process Timeline" class="sapUiMediumMarginBottom">
                    <content>
                        <VBox class="sapUiSmallMargin">
                            <HBox class="sapUiSmallMarginBottom" alignItems="Center">
                                <ObjectStatus 
                                    state="Success"
                                    icon="sap-icon://create"
                                    class="sapUiTinyMarginEnd"/>
                                <VBox class="sapUiTinyMarginBegin">
                                    <Title text="PR Creation" level="H4"/>
                                    <Text text="Purchase request created and submitted"/>
                                </VBox>
                                <ToolbarSpacer/>
                                <Text text="Step 1 of 4" class="sapUiTinyMarginEnd"/>
                            </HBox>
                            
                            <HBox class="sapUiSmallMarginBottom" alignItems="Center">
                                <ObjectStatus 
                                    state="Success"
                                    icon="sap-icon://manager"
                                    class="sapUiTinyMarginEnd"/>
                                <VBox class="sapUiTinyMarginBegin">
                                    <Title text="Manager Review" level="H4"/>
                                    <Text text="Department manager review and approval"/>
                                </VBox>
                                <ToolbarSpacer/>
                                <Text text="Step 2 of 4" class="sapUiTinyMarginEnd"/>
                            </HBox>
                            
                            <HBox class="sapUiSmallMarginBottom" alignItems="Center">
                                <ObjectStatus 
                                    state="Warning"
                                    icon="sap-icon://payment-approval"
                                    class="sapUiTinyMarginEnd"/>
                                <VBox class="sapUiTinyMarginBegin">
                                    <Title text="Finance Approval" level="H4"/>
                                    <Text text="Finance department budget approval"/>
                                </VBox>
                                <ToolbarSpacer/>
                                <Text text="Step 3 of 4" class="sapUiTinyMarginEnd"/>
                            </HBox>
                            
                            <HBox class="sapUiSmallMarginBottom" alignItems="Center">
                                <ObjectStatus 
                                    state="None"
                                    icon="sap-icon://shipping-status"
                                    class="sapUiTinyMarginEnd"/>
                                <VBox class="sapUiTinyMarginBegin">
                                    <Title text="PO Generation" level="H4"/>
                                    <Text text="Purchase order generation and supplier dispatch"/>
                                </VBox>
                                <ToolbarSpacer/>
                                <Text text="Step 4 of 4" class="sapUiTinyMarginEnd"/>
                            </HBox>
                        </VBox>
                    </content>
                </Panel>
                
                <!-- Detailed Data Table -->
                <Panel headerText="Detailed Procurement Data" expandable="true" expanded="false">
                    <headerToolbar>
                        <OverflowToolbar>
                            <Title text="Transaction Details" level="H3"/>
                            <ToolbarSpacer/>
                            <SearchField 
                                width="200px"
                                placeholder="Search transactions..."
                                search=".onSearchTransactions"/>
                        </OverflowToolbar>
                    </headerToolbar>
                    <content>
                        <Table 
                            items="{analytics>/transactions}"
                            class="sapUiResponsiveMargin">
                            <columns>
                                <Column>
                                    <Text text="PR Number"/>
                                </Column>
                                <Column>
                                    <Text text="Date"/>
                                </Column>
                                <Column>
                                    <Text text="Department"/>
                                </Column>
                                <Column>
                                    <Text text="Supplier"/>
                                </Column>
                                <Column>
                                    <Text text="Amount"/>
                                </Column>
                                <Column>
                                    <Text text="Status"/>
                                </Column>
                                <Column>
                                    <Text text="Processing Time"/>
                                </Column>
                            </columns>
                            <items>
                                <ColumnListItem>
                                    <cells>
                                        <Text text="{analytics>prNumber}"/>
                                        <Text text="{analytics>date}"/>
                                        <Text text="{analytics>department}"/>
                                        <Text text="{analytics>supplier}"/>
                                        <ObjectNumber 
                                            number="{analytics>amount}"
                                            unit="USD"/>
                                        <ObjectStatus 
                                            text="{analytics>status}"
                                            state="{
                                                path: 'analytics>status',
                                                formatter: '.formatter.statusState'
                                            }"/>
                                        <Text text="{analytics>processingTime}"/>
                                    </cells>
                                </ColumnListItem>
                            </items>
                        </Table>
                    </content>
                </Panel>
                
            </ScrollContainer>
        </content>
        
        <footer>
            <OverflowToolbar>
                <ToolbarSpacer/>
                <Text text="Data as of: {analytics>/lastUpdated}" class="sapUiTinyMarginEnd"/>
                <Button 
                    text="Export Full Report"
                    icon="sap-icon://excel-attachment"
                    press=".onExportFullReport"/>
            </OverflowToolbar>
        </footer>
        
    </Page>
    
</mvc:View>